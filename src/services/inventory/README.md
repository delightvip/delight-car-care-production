
# نظام تتبع حركات المخزون

## نظرة عامة

نظام تتبع حركات المخزون هو نظام مسؤول عن تسجيل جميع الحركات التي تحدث على المخزون، مثل:
- عمليات الإنتاج (إضافة منتجات نصف مصنعة وخصم المواد الخام)
- عمليات التعبئة (إضافة منتجات نهائية وخصم منتجات نصف مصنعة ومواد التعبئة)
- عمليات البيع (خصم المنتجات)
- عمليات الشراء (إضافة المواد)
- عمليات المرتجعات (إضافة أو خصم حسب نوع المرتجع)

النظام يعمل كطبقة وسيطة تستمع للتغييرات في الجداول المختلفة، وتقوم بتسجيل هذه التغييرات كحركات في جدول `inventory_movements`.

## هيكل النظام

يتكون نظام تتبع حركات المخزون من الخدمات التالية:

### 1. خدمة تتبع حركات المخزون (`InventoryMovementTrackingService`)

مسؤولة عن تسجيل حركات المخزون في الجدول `inventory_movements` وتوفير وظائف للاستعلام عن هذه الحركات.

### 2. خدمة مزامنة حركات المخزون (`InventoryMovementSyncService`)

مسؤولة عن مزامنة حركات المخزون من الجداول المختلفة مثل أوامر الإنتاج والتعبئة والمبيعات والمشتريات، وتسجيلها في جدول حركات المخزون.

### 3. خدمة تقارير حركات المخزون (`InventoryMovementReportingService`)

مسؤولة عن توفير تقارير وإحصائيات عن حركات المخزون.

## الوظائف الرئيسية

### تسجيل الحركات

```typescript
// تسجيل حركة مخزون جديدة
await trackingService.recordMovement({
  item_id: "123",
  item_type: "raw",
  movement_type: "in",
  quantity: 10,
  reason: "استلام مواد"
});
```

### مزامنة الحركات

```typescript
// مزامنة جميع حركات المخزون
await syncService.syncAllMovements();

// مزامنة حركات المخزون من أوامر الإنتاج فقط
await syncService.syncProductionOrders();
```

### استعلام عن الحركات

```typescript
// الحصول على حركات عنصر معين
const movements = await trackingService.getItemMovements("123", "raw");

// الحصول على حركات المخزون الأخيرة
const recentMovements = await trackingService.getRecentMovements(10);

// الحصول على حركات عنصر مجمعة حسب الفترة
const chartData = await trackingService.getItemMovementsByTime("123", "raw", "month");
```

## جدول حركات المخزون

يتم تسجيل جميع حركات المخزون في جدول `inventory_movements` بالهيكل التالي:

| الحقل | الوصف |
|-------|-------|
| id | معرف الحركة |
| item_id | معرف العنصر |
| item_type | نوع العنصر (raw, semi, packaging, finished) |
| movement_type | نوع الحركة (in, out) |
| quantity | الكمية |
| balance_after | الرصيد بعد الحركة |
| reason | سبب الحركة |
| created_at | تاريخ إنشاء الحركة |
| updated_at | تاريخ تحديث الحركة |
| user_id | معرف المستخدم الذي قام بالحركة |

## واجهات النظام

### واجهة سجل حركات العنصر

توفر واجهة لعرض سجل حركات عنصر معين مع إمكانية عرض الرسم البياني للحركات.

### واجهة تتبع المخزون

توفر واجهة شاملة لتتبع حركات المخزون مع إمكانية التصفية حسب الفئة ونوع الحركة والتاريخ.

### واجهة مزامنة حركات المخزون

توفر واجهة لمزامنة حركات المخزون من الجداول المختلفة.

## كيفية استخدام النظام

1. استخدم خدمة تتبع حركات المخزون لتسجيل حركات جديدة.
2. استخدم خدمة مزامنة حركات المخزون لمزامنة الحركات من الجداول المختلفة.
3. استخدم خدمة تقارير حركات المخزون للحصول على تقارير وإحصائيات.
4. استخدم واجهات النظام المختلفة لعرض وتتبع حركات المخزون.
